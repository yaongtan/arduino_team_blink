<!--NodeMCU : ì„œë²„-->
<!--SDì¹´ë“œ : DB-->

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLINK_web service (SD Card)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            background-color: #f4f7f6; 
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; 
            margin: 0; 
            padding: 20px; 
            color: #333; 
        }
        .container { max-width: 1000px; margin: 0 auto; }
        
        h1 { text-align: center; color: #2c3e50; margin-bottom: 20px; font-size: 1.8rem; }

        /* 1. ì§„ë‹¨ ë©”ì‹œì§€ ì¹´ë“œ */
        .diagnosis-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            border-left: 10px solid #ccc;
            transition: all 0.3s ease;
        }
        .diagnosis-title { font-size: 1.6em; font-weight: bold; margin-bottom: 10px; }
        .diagnosis-text { font-size: 1.1em; line-height: 1.6; color: #555; }
        .recommendation { 
            margin-top: 15px; 
            padding: 15px; 
            background-color: #f8f9fa; 
            border-radius: 8px; 
            font-weight: bold; 
            color: #444; 
            display: inline-block;
            border: 1px solid #eee;
        }

        /* 2. ëœë¤ ë°ì´í„° ìƒì„± */
        .control-panel { 
            text-align: center; 
            margin-bottom: 30px; 
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        .control-title { margin-bottom: 15px; font-size: 0.95em; color: #666; font-weight: bold; }
        
        .date-picker {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-right: 10px;
            font-family: inherit;
        }

        button {
            padding: 12px 20px; 
            font-size: 15px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            color: white; 
            font-weight: bold; 
            margin: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        .btn-led { background: linear-gradient(135deg, #FF6384, #d63c5e); }
        .btn-rhythm { background: linear-gradient(135deg, #36A2EB, #258cd1); }

        /* 3. ê·¸ë˜í”„ ë ˆì´ì•„ì›ƒ */
        .chart-container { 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
        }
        .chart-title { text-align: center; font-weight: bold; margin-bottom: 15px; color: #555; }
        .row { display: flex; gap: 20px; }
        .col { flex: 1; }
        @media (max-width: 768px) { .row { flex-direction: column; } }

        /* 4. ë°ì´í„° ë¡œê·¸ í…Œì´ë¸” */
        .table-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            margin-bottom: 30px; 
            overflow-x: auto; 
        }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #555; font-weight: bold; }
        tr:hover { background-color: #f1f1f1; } 
    
        .type-led { color: #FF6384; font-weight: bold; }
        .type-rhythm { color: #36A2EB; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>[ì˜¤ëŠ˜ì˜ ë¶„ì„ ë³´ê³ ì„œ]</h1>

    <div id="ai-message-box" class="diagnosis-card">
        <div class="diagnosis-title">ë°ì´í„° ë¶„ì„ ëŒ€ê¸° ì¤‘...</div>
        <div class="diagnosis-text">ë¡œë”© ì¤‘ì´ê±°ë‚˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ê²Œì„ì„ ì§„í–‰í•˜ê³  ì˜¤ëŠ˜ì˜ ìƒíƒœë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</div>
    </div>

    <div class="chart-container">
        <div class="chart-title">ì¼ë³„ í‰ê·  ì •í™•ë„ ì¶”ì´ (%)</div>
        <canvas id="accuracyChart"></canvas>
    </div>

    <div class="row">
        <div class="col chart-container">
            <div class="chart-title" style="color:#FF6384;">LED ë°˜ì‘ ì†ë„ (ì´ˆ)</div>
            <canvas id="ledTimeChart"></canvas>
        </div>
        <div class="col chart-container">
            <div class="chart-title" style="color:#36A2EB;">ë°•ì ê²Œì„ ì†Œìš” ì‹œê°„ (ì´ˆ)</div>
            <canvas id="rhythmTimeChart"></canvas>
        </div>
    </div>

    <div class="control-panel">
        <div class="control-title">í•˜ë“œì›¨ì–´ ì˜¤ë¥˜ ëŒ€ë¹„ ì‹œë®¬ë ˆì´ì…˜ (í™”ë©´ ê°±ì‹ ìš©)</div>
        <input type="date" id="sim-date" class="date-picker">
        <br><br>
        <button class="btn-led" onclick="simulateGame('LED')">LED ê²Œì„ ê¸°ë¡ ì¶”ê°€</button>
        <button class="btn-rhythm" onclick="simulateGame('RHYTHM')">ë°•ì ê²Œì„ ê¸°ë¡ ì¶”ê°€</button>
    </div>

    <div class="table-container">
        <div class="chart-title">ê²Œì„ ê¸°ë¡ (ìµœê·¼ 10ê°œ)</div>
        <table>
            <thead>
                <tr>
                    <th>ì‹œê°„</th>
                    <th>ê²Œì„ ì¢…ë¥˜</th>
                    <th>ì •í™•ë„</th>
                    <th>ì†Œìš” ì‹œê°„</th>
                </tr>
            </thead>
            <tbody id="logTableBody">
                </tbody>
        </table>
    </div>

</div>

<script>
    // --- [A] ì „ì—­ ë³€ìˆ˜ ì„¤ì • ---
    let allLogs = []; // ë¡œë“œëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì €ì¥í•  ë°°ì—´

    // ë‚ ì§œ ì„ íƒê¸° ê¸°ë³¸ê°’ì„ ì˜¤ëŠ˜ë¡œ ì„¤ì •
    document.getElementById('sim-date').valueAsDate = new Date();

    // --- [B] ì°¨íŠ¸ ì´ˆê¸°í™” (Chart.js) ---
    const accCtx = document.getElementById('accuracyChart').getContext('2d');
    const accuracyChart = new Chart(accCtx, {
        type: 'line',
        data: { labels: [], datasets: [
            { label: 'LED ì •í™•ë„', borderColor: '#FF6384', backgroundColor: '#FF6384', data: [], tension: 0.3, pointRadius: 5 },
            { label: 'ë°•ì ì •í™•ë„', borderColor: '#36A2EB', backgroundColor: '#36A2EB', data: [], tension: 0.3, pointRadius: 5 }
        ]},
        options: { responsive: true, scales: { y: { min: 0, max: 100 } } }
    });

    const ledTimeCtx = document.getElementById('ledTimeChart').getContext('2d');
    const ledTimeChart = new Chart(ledTimeCtx, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'ë°˜ì‘ ì‹œê°„', backgroundColor: '#FF6384', data: [] }] },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    const rhythmTimeCtx = document.getElementById('rhythmTimeChart').getContext('2d');
    const rhythmTimeChart = new Chart(rhythmTimeCtx, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'ì†Œìš” ì‹œê°„', backgroundColor: '#36A2EB', data: [] }] },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });


    // --- [C] ë°ì´í„° ë¡œë“œ ë° íŒŒì‹± (í•µì‹¬ ë³€ê²½ ë¶€ë¶„) ---
    async function loadData() {
        try {
            // NodeMCUì˜ /api/data ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
            const response = await fetch('/api/data');
            if (!response.ok) throw new Error("No data file or Server Error");
            
            const text = await response.text();
            
            // CSV í…ìŠ¤íŠ¸ íŒŒì‹± (í˜•ì‹: timestamp,game_type,accuracy,play_time)
            const lines = text.trim().split('\n');
            allLogs = []; // ì´ˆê¸°í™”

            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 4) {
                    allLogs.push({
                        timestamp: parseInt(parts[0]), // ms ë‹¨ìœ„ íƒ€ì„ìŠ¤íƒ¬í”„
                        game_type: parts[1].trim(),    // "LED" or "RHYTHM"
                        accuracy: parseFloat(parts[2]),
                        play_time: parseFloat(parts[3])
                    });
                }
            });

            // ë°ì´í„° ì²˜ë¦¬ ë° ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
            updateDashboard(allLogs);

        } catch (error) {
            console.warn("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (ì•„ì§ ê¸°ë¡ì´ ì—†ê±°ë‚˜ ì—°ê²° ë¬¸ì œ):", error);
            // ì—ëŸ¬ ì‹œ ë¹ˆ í™”ë©´ ìœ ì§€ í˜¹ì€ ë”ë¯¸ ë°ì´í„° í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
            // updateDashboard([]); 
        }
    }

    // --- [D] ë°ì´í„° ê°€ê³µ ë° í™”ë©´ ê°±ì‹  (ê¸°ì¡´ ë¡œì§ ìœ ì§€) ---
    function updateDashboard(dataArray) {
        if (!dataArray || dataArray.length === 0) return;

        // 1. ë‚ ì§œë³„ ê·¸ë£¹í™”
        let dailyGroups = {};
        let stats = {
            LED: { historyAcc: [], historyTime: [], todayAcc: [], todayTime: [] },
            RHYTHM: { historyAcc: [], historyTime: [], todayAcc: [], todayTime: [] }
        };

        const today = new Date();
        today.setHours(0,0,0,0); 

        // ì‹œê°„ìˆœ ì •ë ¬
        const sortedLogs = dataArray.sort((a, b) => a.timestamp - b.timestamp);

        // ìµœê·¼ ê¸°ë¡ 10ê°œ í…Œì´ë¸” í‘œì‹œ
        const recentLogs = sortedLogs.slice().reverse().slice(0, 10);
        updateLogTable(recentLogs);

        sortedLogs.forEach(log => {
            const logDate = new Date(log.timestamp);
            const dateKey = `${logDate.getMonth()+1}/${logDate.getDate()}`;
            
            // ê·¸ë˜í”„ìš© ê·¸ë£¹í™”
            if (!dailyGroups[dateKey]) {
                dailyGroups[dateKey] = { 
                    LED: { accSum: 0, timeSum: 0, count: 0 }, 
                    RHYTHM: { accSum: 0, timeSum: 0, count: 0 } 
                };
            }
            const group = dailyGroups[dateKey][log.game_type];
            if (group) {
                group.accSum += log.accuracy;
                group.timeSum += log.play_time;
                group.count += 1;
            }

            // ì§„ë‹¨ìš© í†µê³„ (ì˜¤ëŠ˜ vs ê³¼ê±°)
            const isToday = logDate >= today;
            if (stats[log.game_type]) {
                const targetAcc = isToday ? stats[log.game_type].todayAcc : stats[log.game_type].historyAcc;
                const targetTime = isToday ? stats[log.game_type].todayTime : stats[log.game_type].historyTime;
                targetAcc.push(log.accuracy);
                targetTime.push(log.play_time);
            }
        });

        // í‰ê·  ê³„ì‚° ë° ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
        let chartLabels = Object.keys(dailyGroups);
        let accLedAvg = [], accRhythmAvg = [];
        let timeLedAvg = [], timeRhythmAvg = [];

        chartLabels.forEach(date => {
            const dayData = dailyGroups[date];
            
            // LED
            if (dayData.LED.count > 0) {
                accLedAvg.push((dayData.LED.accSum / dayData.LED.count).toFixed(1));
                timeLedAvg.push((dayData.LED.timeSum / dayData.LED.count).toFixed(1));
            } else {
                accLedAvg.push(null);
                timeLedAvg.push(null);
            }
            // Rhythm
            if (dayData.RHYTHM.count > 0) {
                accRhythmAvg.push((dayData.RHYTHM.accSum / dayData.RHYTHM.count).toFixed(1));
                timeRhythmAvg.push((dayData.RHYTHM.timeSum / dayData.RHYTHM.count).toFixed(1));
            } else {
                accRhythmAvg.push(null);
                timeRhythmAvg.push(null);
            }
        });

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        accuracyChart.data.labels = chartLabels;
        accuracyChart.data.datasets[0].data = accLedAvg;
        accuracyChart.data.datasets[1].data = accRhythmAvg;
        accuracyChart.update();

        ledTimeChart.data.labels = chartLabels;
        ledTimeChart.data.datasets[0].data = timeLedAvg;
        ledTimeChart.update();

        rhythmTimeChart.data.labels = chartLabels;
        rhythmTimeChart.data.datasets[0].data = timeRhythmAvg;
        rhythmTimeChart.update();

        // ì§„ë‹¨ ì‹¤í–‰
        runDiagnosis(stats);
    }

    // í‰ê·  í—¬í¼ í•¨ìˆ˜
    const getAvg = (arr) => arr.length ? (arr.reduce((a,b)=>a+b,0) / arr.length) : 0;

    // --- [E] ì»¨ë””ì…˜ ì§„ë‹¨ ë¡œì§ (ê¸°ì¡´ ë™ì¼) ---
    function runDiagnosis(stats) {
        const msgBox = document.getElementById('ai-message-box');
        const title = msgBox.querySelector('.diagnosis-title');
        const text = msgBox.querySelector('.diagnosis-text');

        if (stats.LED.todayAcc.length === 0 && stats.RHYTHM.todayAcc.length === 0) {
            title.innerHTML = "ì˜¤ëŠ˜ì˜ ê¸°ë¡ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";
            text.innerHTML = "ì˜¤ëŠ˜ì˜ ê²Œì„ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.";
            msgBox.style.borderLeftColor = "#ccc"; 
            msgBox.style.backgroundColor = "#fff";
            return;
        }

        const getScore = (today, history, isTime) => {
            const baseVal = history || (isTime ? 30 : 70);
            if (isTime) return today <= baseVal ? 1 : 0;
            return today >= baseVal ? 1 : 0;
        };

        const todayLedAcc = getAvg(stats.LED.todayAcc);
        const todayLedTime = getAvg(stats.LED.todayTime);
        const todayBeatAcc = getAvg(stats.RHYTHM.todayAcc);
        const todayBeatTime = getAvg(stats.RHYTHM.todayTime);

        const L_Acc = getScore(todayLedAcc, getAvg(stats.LED.historyAcc), false);
        const L_Time = getScore(todayLedTime, getAvg(stats.LED.historyTime), true);
        const B_Acc = getScore(todayBeatAcc, getAvg(stats.RHYTHM.historyAcc), false);
        const B_Time = getScore(todayBeatTime, getAvg(stats.RHYTHM.historyTime), true);

        const totalScore = L_Acc + L_Time + B_Acc + B_Time;
        const accScore = L_Acc + B_Acc;
        const timeScore = L_Time + B_Time;

        if (totalScore >= 3) {
            title.innerHTML = "ğŸŒŸ ìµœìƒì˜ ì»¨ë””ì…˜ ğŸŒŸ";
            text.innerHTML = `ëª¸ë„ ë§ˆìŒë„ ì²­ì¶˜ì´ì‹œë„¤ìš”!<br><div class='recommendation'>ì¶”ì²œ í™œë™: ê°€ë²¼ìš´ ì‚°ì±…ì„ í•˜ì‹œê±°ë‚˜ ë°”ë‘‘/ì¥ê¸°ë¥¼ í•œ íŒ ë‘¬ë³´ì„¸ìš”!</div>`;
            msgBox.style.borderLeftColor = "#4CAF50"; 
            msgBox.style.backgroundColor = "#E8F5E9";
        } else if (totalScore === 0) {
            title.innerHTML = "ğŸ˜´ íœ´ì‹ì´ í•„ìš”í•œ í•˜ë£¨";
            text.innerHTML = `ì˜¤ëŠ˜ ëª¸ì´ ë¬´ê±°ìš°ì‹œì§„ ì•Šìœ¼ì‹ ê°€ìš”?<br><div class='recommendation'>ì¶”ì²œ í™œë™: ë¬´ë¦¬í•˜ì§€ ë§ˆì‹œê³  ë”°ëœ»í•œ ì°¨ì™€ í•¨ê»˜ íœ´ì‹ì„ ì·¨í•´ë³´ì„¸ìš”.</div>`;
            msgBox.style.borderLeftColor = "#F44336"; 
            msgBox.style.backgroundColor = "#FFEBEE";
        } else if (accScore === 2 && timeScore === 0) {
            title.innerHTML = "ğŸ¢ ì‹ ì¤‘í•œ í•˜ë£¨ ğŸ¢";
            text.innerHTML = `ë‚˜ë¹„ì²˜ëŸ¼ ë‚ ì•„ ë²Œì²˜ëŸ¼ ìœë‹¤!<br><div class='recommendation'>ì¶”ì²œ í™œë™: êµ³ì€ ëª¸ì„ í’€ì–´ì£¼ëŠ” ìŠ¤íŠ¸ë ˆì¹­ì´ í•„ìš”í•´ìš”. ê¸°ì§€ê°œë¥¼ í•œë²ˆ ì‹œì›í•˜ê²Œ ì¼œë³¼ê¹Œìš”?</div>`;
            msgBox.style.borderLeftColor = "#FF9800"; 
            msgBox.style.backgroundColor = "#FFF3E0";
        } else if (timeScore === 2 && accScore === 0) {
            title.innerHTML = "âš¡ ì¡°ê¸‰í•œ í•˜ë£¨ âš¡";
            text.innerHTML = `í‹€ë ¤ë„ ê´œì°®ì•„ìš”! í‰ì˜¨í•œ ë§ˆìŒì„ ê°€ì ¸ë³´ì„¸ìš”.<br><div class='recommendation'>ì¶”ì²œ í™œë™: ì°¨ë¶„í•œ ìŒì•…ê³¼ í•¨ê»˜ ì˜›ë‚  ì‚¬ì§„ì²©ì„ ì°¬ì°¬íˆ ë„˜ê²¨ë³´ë©° ì¶”ì–µ ì—¬í–‰ì„ ë– ë‚˜ë³´ì„¸ìš”.</div>`;
            msgBox.style.borderLeftColor = "#9C27B0"; 
            msgBox.style.backgroundColor = "#F3E5F5";
        } else {
            title.innerHTML = "ğŸ™‚ í‰ì˜¨í•œ í•˜ë£¨ ğŸ™‚";
            text.innerHTML = `ì˜¤ëŠ˜ë„ í•œê²°ê°™ì´ ê±´ê°•í•œ ëª¨ìŠµì´ì‹œêµ°ìš”!<br><div class='recommendation'>ì¶”ì²œ í™œë™: ê°€ì¡±ì´ë‚˜ ì¹œêµ¬ì—ê²Œ ì „í™”í•´ ë°˜ê°€ìš´ ëª©ì†Œë¦¬ë¥¼ ë“¤ì–´ë³´ì„¸ìš”.</div>`;
            msgBox.style.borderLeftColor = "#2196F3"; 
            msgBox.style.backgroundColor = "#E3F2FD";
        }
    }

    // --- [F] ë¡œì»¬ ì‹œë®¬ë ˆì´ì…˜ (SDì¹´ë“œ ì „ì†¡ X, í™”ë©´ í…ŒìŠ¤íŠ¸ìš©) ---
    window.simulateGame = function(type) {
        let baseTime = type === "LED" ? 20 : 45;
        let finalTime = baseTime + (Math.random() * 20 - 5);
        let acc = (50 + Math.random() * 50).toFixed(1);

        const dateInput = document.getElementById('sim-date').value;
        const selectedDate = new Date(dateInput);
        
        const randomHour = Math.floor(Math.random() * 12) + 9;
        const randomMin = Math.floor(Math.random() * 60);
        selectedDate.setHours(randomHour, randomMin, 0);

        // ë¡œì»¬ ë°°ì—´ì—ë§Œ ì¶”ê°€ (ì„œë²„ ì „ì†¡ ì—†ìŒ)
        const newLog = {
            game_type: type,
            accuracy: parseFloat(acc),
            play_time: parseFloat(finalTime.toFixed(1)),
            timestamp: selectedDate.getTime()
        };

        allLogs.push(newLog); // ë¡œì»¬ ë°ì´í„°ì— ì¶”ê°€
        updateDashboard(allLogs); // í™”ë©´ ê°±ì‹ 
        
        alert("ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°ê°€ í™”ë©´ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì°¸ê³ : ì´ ë°ì´í„°ëŠ” ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì‚¬ë¼ì§€ë©° SDì¹´ë“œì— ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)");
    }

    // --- [G] í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ ---
    function updateLogTable(logs) {
        const tbody = document.getElementById('logTableBody');
        tbody.innerHTML = ""; 

        logs.forEach(log => {
            const date = new Date(log.timestamp);
            const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const dateStr = `${date.getMonth()+1}/${date.getDate()}`;
            const typeClass = log.game_type === "LED" ? "type-led" : "type-rhythm";
            const typeName = log.game_type === "LED" ? "LED ê²Œì„" : "ë°•ì ê²Œì„";

            const row = `
                <tr>
                    <td>${dateStr} ${timeStr}</td>
                    <td class="${typeClass}">${typeName}</td>
                    <td>${log.accuracy}%</td>
                    <td>${log.play_time}ì´ˆ</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤í–‰
    window.onload = loadData;

</script>
</body>
</html>